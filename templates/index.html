<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI 小说创作台</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800&family=Noto+Serif+SC:wght@500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-1: #f4f1ea;
      --bg-2: #e6edf6;
      --ink: #17212b;
      --muted: #5b6978;
      --card: rgba(255, 255, 255, 0.78);
      --line: rgba(20, 31, 45, 0.12);
      --accent: #0b6bcb;
      --accent-2: #0f8f84;
      --danger: #b42318;
      --ok: #067647;
      --shadow: 0 20px 50px rgba(16, 24, 40, 0.12);
      --radius-xl: 22px;
      --radius-lg: 14px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      color: var(--ink);
      font-family: 'Manrope', sans-serif;
      background:
        radial-gradient(1200px 520px at 12% -5%, #fff5d6 0%, transparent 45%),
        radial-gradient(980px 560px at 100% 0%, #d7e6ff 0%, transparent 45%),
        linear-gradient(145deg, var(--bg-1), var(--bg-2));
      min-height: 100vh;
    }

    .shell {
      max-width: 1320px;
      margin: 0 auto;
      padding: 24px;
    }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 18px;
      gap: 12px;
    }

    .brand {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .badge {
      width: 42px;
      height: 42px;
      border-radius: 12px;
      display: grid;
      place-items: center;
      background: linear-gradient(135deg, #0d74da, #0fa39a);
      color: white;
      font-weight: 800;
      box-shadow: 0 10px 24px rgba(15, 115, 205, 0.35);
    }

    .brand h1 {
      margin: 0;
      font-size: 22px;
      line-height: 1.1;
      letter-spacing: 0.2px;
    }

    .brand p {
      margin: 3px 0 0;
      color: var(--muted);
      font-size: 12px;
    }

    .layout {
      display: grid;
      grid-template-columns: 410px 1fr;
      gap: 18px;
      align-items: start;
    }

    .panel {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .left {
      padding: 18px;
      position: sticky;
      top: 14px;
    }

    .right {
      padding: 18px;
      min-height: 72vh;
    }

    .section {
      margin-bottom: 14px;
      padding: 14px;
      background: rgba(255,255,255,0.72);
      border: 1px solid var(--line);
      border-radius: var(--radius-lg);
    }

    .section h3 {
      margin: 0 0 10px;
      font-size: 13px;
      letter-spacing: 0.2px;
      color: #233445;
    }
    .left-tabs {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
      margin-bottom: 12px;
    }
    .tab-btn {
      border: 1px solid #d1deec;
      background: #f8fbff;
      color: #304457;
      border-radius: 10px;
      font-size: 12px;
      padding: 7px 8px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }
    .tab-btn.active {
      background: #eaf3ff;
      border-color: #8bb9ea;
      color: #0f4f8f;
    }
    .tab-meta {
      font-size: 10px;
      border: 1px solid #c9d9eb;
      border-radius: 999px;
      padding: 1px 6px;
      background: #fff;
      color: #52667a;
      min-width: 34px;
      text-align: center;
    }
    .settings-btn {
      border: 1px solid #d1deec;
      background: #f8fbff;
      color: #304457;
      border-radius: 10px;
      font-size: 12px;
      padding: 8px 10px;
      font-weight: 700;
      cursor: pointer;
    }
    .settings-modal {
      position: fixed;
      inset: 0;
      background: rgba(12, 20, 30, 0.42);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
      padding: 18px;
    }
    .settings-modal.show { display: flex; }
    .settings-card {
      width: min(980px, 96vw);
      max-height: 88vh;
      overflow: auto;
      background: #ffffff;
      border: 1px solid #d7e2ef;
      border-radius: 14px;
      box-shadow: 0 25px 60px rgba(16,24,40,.25);
      padding: 14px;
    }
    .pane-hidden { display: none; }
    details.section summary {
      cursor: pointer;
      list-style: none;
      font-size: 13px;
      font-weight: 700;
      color: #233445;
      margin-bottom: 8px;
    }
    details.section[open] summary { margin-bottom: 10px; }
    details.subbox {
      border: 1px solid #d9e4f0;
      border-radius: 12px;
      background: #ffffffc9;
      padding: 8px 10px;
      margin-top: 8px;
    }
    details.subbox summary {
      cursor: pointer;
      font-size: 12px;
      font-weight: 700;
      color: #294155;
      margin-bottom: 6px;
      list-style: none;
    }

    label {
      display: block;
      font-size: 12px;
      color: #2d3d4f;
      margin: 0 0 6px;
      font-weight: 700;
    }

    input, textarea, select, button {
      font: inherit;
    }

    input, textarea, select {
      width: 100%;
      border: 1px solid #cad7e5;
      background: #fff;
      border-radius: 12px;
      padding: 10px 12px;
      color: #102030;
      outline: none;
      transition: border-color .2s, box-shadow .2s, transform .2s;
    }

    textarea { resize: vertical; min-height: 82px; }

    input:focus, textarea:focus, select:focus {
      border-color: #6da8e6;
      box-shadow: 0 0 0 4px rgba(59,130,246,0.16);
    }

    .row { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: end; }

    .btn {
      border: 1px solid transparent;
      border-radius: 12px;
      padding: 10px 12px;
      cursor: pointer;
      font-weight: 700;
      transition: transform .15s ease, box-shadow .2s, background .2s;
    }

    .btn:active { transform: translateY(1px); }

    .btn-main {
      width: 100%;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: white;
      box-shadow: 0 10px 20px rgba(11, 107, 203, 0.25);
      margin-top: 4px;
    }

    .btn-main:hover { filter: brightness(1.03); }

    .btn-soft {
      background: #fff;
      border-color: #d5dfec;
      color: #243447;
      padding: 8px 10px;
      font-size: 12px;
    }

    .wizard-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .step {
      font-size: 11px;
      color: #5e6d7d;
      border: 1px solid #d2deeb;
      background: #f9fbfe;
      border-radius: 999px;
      padding: 3px 9px;
    }

    .progress {
      height: 8px;
      width: 100%;
      border-radius: 999px;
      background: #e6eef8;
      overflow: hidden;
      margin: 8px 0 10px;
      border: 1px solid #d2deeb;
    }

    .progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #0b6bcb, #0f8f84);
      transition: width .2s ease;
    }

    .question-list { display: grid; gap: 10px; }

    .q-item {
      border: 1px solid #d9e4f0;
      border-radius: 12px;
      background: #ffffffc9;
      padding: 10px;
    }

    .q-item.active {
      border-color: #79aee7;
      box-shadow: 0 0 0 3px rgba(59,130,246,0.12);
      background: #f7fbff;
    }

    .q-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .q-title {
      font-size: 12px;
      font-weight: 700;
      color: #24384a;
    }

    .q-tag {
      font-size: 10px;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid #cad9ea;
      color: #506277;
      background: #f8fbff;
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .chip-btn {
      border: 1px solid #d5dfec;
      background: #fff;
      color: #34485b;
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      cursor: pointer;
    }

    .chip-btn:hover { background: #f5f9ff; border-color: #bcd3eb; }

    .status {
      margin-top: 8px;
      font-size: 12px;
      color: #3c4c5c;
      min-height: 18px;
    }
    .status-progress {
      margin-top: 6px;
      height: 6px;
      border-radius: 999px;
      background: #e4edf7;
      border: 1px solid #d2deeb;
      overflow: hidden;
      display: none;
    }
    .status-progress.show { display: block; }
    .status-progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #0b6bcb, #0f8f84);
      transition: width .35s ease;
    }
    .status.warn { color: #9a6700; }
    .status.good { color: #067647; }

    .title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
      padding-bottom: 10px;
      border-bottom: 1px dashed #ccd8e5;
    }

    .title h2 {
      margin: 0;
      font-size: 24px;
      font-family: 'Noto Serif SC', serif;
      letter-spacing: 0.3px;
    }

    .chip {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #c9d7e7;
      color: #405468;
      background: #f8fbff;
    }

    .chapter {
      border: 1px solid #d8e2ee;
      background: rgba(255,255,255,0.84);
      border-radius: 14px;
      overflow: hidden;
      animation: rise .32s ease;
    }

    @keyframes rise {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .chapter-hd {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      padding: 11px 13px;
      border-bottom: 1px solid #e2e9f1;
      background: linear-gradient(180deg, #f9fcff, #f4f8fd);
    }

    .chapter-hd h3 { margin: 0; font-size: 14px; }

    .chapter-bd {
      padding: 14px;
      font-size: 14px;
      line-height: 1.9;
      color: #1f2f3d;
    }

    .empty {
      color: #607080;
      font-size: 13px;
      text-align: center;
      padding: 50px 10px;
      border: 1px dashed #cad8e8;
      border-radius: 14px;
      background: rgba(255,255,255,.45);
    }

    .ok { color: var(--ok); }
    .bad { color: var(--danger); }

    @media (max-width: 1060px) {
      .layout { grid-template-columns: 1fr; }
      .left { position: static; }
    }
  </style>
</head>
<body>
  <div class="shell">
    <header class="topbar">
      <div class="brand">
        <div class="badge">AI</div>
        <div>
          <h1>小说创作控制台</h1>
          <p>商业化风格工作台 · 分步创作 · 模型可观测</p>
        </div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        <span class="chip" id="model-test-status">未检测模型</span>
        <button id="open-settings-btn" class="settings-btn">系统设置</button>
      </div>
    </header>

    <div class="layout">
      <aside class="panel left">
        <div class="left-tabs">
          <button type="button" class="tab-btn active" data-tab="basic">基础 <span class="tab-meta" id="meta-basic">0/2</span></button>
          <button type="button" class="tab-btn" data-tab="guide">引导 <span class="tab-meta" id="meta-guide">0/5</span></button>
          <button type="button" class="tab-btn" data-tab="advanced">世界观 <span class="tab-meta" id="meta-advanced">0/4</span></button>
        </div>
        <div id="tab-hint" style="font-size:11px;color:#5b6978;margin:0 0 10px 2px;"></div>

        <section class="section" data-pane="basic">
          <h3>题材与核心</h3>
          <label for="genre">题材风格补充</label>
          <input id="genre" placeholder="如：新中式悬疑、玄幻升级流" />
        </section>

        <section class="section" data-pane="basic">
          <h3>故事核心</h3>
          <label for="core-prompt">核心创意描述</label>
          <textarea id="core-prompt" rows="4" placeholder="一句话说清故事：主角是谁，想要什么，阻碍是什么"></textarea>
        </section>

        <details class="section" data-pane="advanced">
          <summary>高级设置（可折叠）</summary>
          <h3>高级设置</h3>
          <label for="style-prompt">自定义写作风格</label>
          <textarea id="style-prompt" rows="2" placeholder="如：短句、高密度对话、冷峻叙事"></textarea>
          <label for="custom-prompt" style="margin-top:8px;">Prompt 调整（可视化模板附加）</label>
          <textarea id="custom-prompt" rows="2" placeholder="附加要求：比如前三章强冲突、每章结尾反转"></textarea>
          <label for="style-strength" style="margin-top:8px;">风格锁定强度</label>
          <select id="style-strength">
            <option value="weak">弱（更自由）</option>
            <option value="medium" selected>中（平衡）</option>
            <option value="strong">强（严格贴合）</option>
          </select>
          <div class="row" style="grid-template-columns:1fr 1fr; margin-top:8px;">
            <div>
              <label for="chapter-min-words">单章最小字数</label>
              <input id="chapter-min-words" type="number" value="3000" min="500" step="100" />
            </div>
            <div>
              <label for="chapter-max-words">单章最大字数</label>
              <input id="chapter-max-words" type="number" value="5000" min="800" step="100" />
            </div>
          </div>
          <label for="analysis-notes" style="margin-top:8px;">分析建议（用于一键重写）</label>
          <textarea id="analysis-notes" rows="2" placeholder="如：第二章冲突弱、对话重复，请增强钩子"></textarea>
          <div class="row" style="grid-template-columns:1fr 1fr 1fr; margin-top:8px;">
            <div>
              <label for="threshold-readability">发布阈值-可读性</label>
              <input id="threshold-readability" type="number" min="0" max="100" value="65" />
            </div>
            <div>
              <label for="threshold-coherence">发布阈值-连贯性</label>
              <input id="threshold-coherence" type="number" min="0" max="100" value="65" />
            </div>
            <div>
              <label for="threshold-hook-rate">发布阈值-钩子率(%)</label>
              <input id="threshold-hook-rate" type="number" min="0" max="100" value="60" />
            </div>
          </div>
          <details class="subbox" open>
            <summary>职业体系</summary>
            <label for="profession-preset">职业等级体系预设</label>
            <select id="profession-preset">
              <option value="">自定义</option>
              <option value="cultivation">修仙境界（炼气-筑基-金丹-元婴-化神）</option>
              <option value="magic">魔法等级（学徒-初阶-中阶-高阶-圣阶）</option>
              <option value="mecha">机甲军衔（新兵-士官-尉官-校官-将官）</option>
            </select>
            <label for="profession-system" style="margin-top:8px;">职业/等级体系描述</label>
            <textarea id="profession-system" rows="2" placeholder="如：修仙体系，境界越高寿命越长，突破需渡劫"></textarea>
          </details>
          <details class="subbox">
            <summary>角色与组织卡</summary>
            <label for="role-cards">角色卡（JSON数组）</label>
            <textarea id="role-cards" rows="2" placeholder='[{"name":"林夜","goal":"复仇","trait":"隐忍"}]'></textarea>
            <label for="org-cards" style="margin-top:8px;">组织卡（JSON数组）</label>
            <textarea id="org-cards" rows="2" placeholder='[{"name":"玄霄宗","position":"正道第一宗"}]'></textarea>
          </details>
          <details class="subbox">
            <summary>伏笔管理</summary>
            <label for="foreshadows">伏笔管理（JSON数组）</label>
            <textarea id="foreshadows" rows="2" placeholder='[{"hint":"黑戒指异动","chapter":"第3章","status":"open"}]'></textarea>
          </details>
          <div class="chips" style="margin-top:8px;">
            <button type="button" id="inspiration-btn" class="chip-btn">灵感模式</button>
            <button type="button" id="rewrite-btn" class="chip-btn">根据分析一键重写</button>
            <button type="button" id="export-btn" class="chip-btn">导出项目JSON</button>
            <button type="button" id="import-btn" class="chip-btn">导入项目JSON</button>
            <button type="button" id="export-cards-btn" class="chip-btn">导出角色/组织卡</button>
            <button type="button" id="import-cards-btn" class="chip-btn">导入角色/组织卡</button>
            <input id="import-file" type="file" accept="application/json" style="display:none;" />
            <input id="import-cards-file" type="file" accept="application/json" style="display:none;" />
          </div>
        </details>

        <section class="section" data-pane="guide">
          <div class="wizard-head">
            <h3 style="margin:0;">5问确认</h3>
            <span id="step-indicator" class="step">已完成 0/5</span>
          </div>
          <div class="progress"><div id="progress-bar" class="progress-bar"></div></div>
          <div id="wizard-body" class="question-list"></div>
        </section>

        <button id="generate-btn" class="btn btn-main">生成小说</button>
        <div id="status" class="status"></div>
        <div id="status-progress" class="status-progress"><div id="status-progress-bar" class="status-progress-bar"></div></div>
      </aside>

      <main class="panel right">
        <div class="title">
          <h2 id="novel-title">未生成</h2>
          <span class="chip">章节结果区</span>
        </div>
        <div class="chip" style="margin-bottom:10px;">模型与发布自动化在右上角“系统设置”中配置</div>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin:0 0 10px;">
          <input id="continue-batch-count" type="number" min="1" value="3" style="width:100px;" />
          <button id="continue-batch-btn" class="btn btn-soft">批量续写N章</button>
        </div>
        <div id="quality-summary" class="chip" style="margin-bottom:10px;display:none;"></div>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin:0 0 10px;">
          <button id="continue-next-btn" class="btn btn-soft">续写下一章</button>
        </div>
        <div id="chapter-pagination" style="display:flex;gap:6px;justify-content:flex-end;align-items:center;margin:0 0 8px;"></div>
        <div id="chapter-toc" style="display:flex;gap:6px;flex-wrap:wrap;margin:0 0 8px;"></div>
        <div id="result-list" style="display:grid;gap:12px;"></div>
      </main>
    </div>
  </div>

  <div id="settings-modal" class="settings-modal">
    <div class="settings-card">
      <div class="title" style="margin-bottom:10px;">
        <h2 style="font-size:20px;">系统设置</h2>
        <button id="close-settings-btn" class="btn btn-soft">关闭</button>
      </div>
      <section class="section">
        <h3>模型与连接</h3>
        <div class="row">
          <select id="model-select"></select>
          <button id="test-models-btn" class="btn btn-soft">测试</button>
        </div>
        <div id="runtime-hint" style="font-size:11px;color:#5b6978;margin-top:6px;"></div>
        <div style="margin-top:10px;">
          <label style="display:flex;align-items:center;gap:8px;font-weight:600;">
            <input id="use-custom-model" type="checkbox" style="width:auto;" />
            使用自定义模型
          </label>
          <div id="custom-model-wrap" style="display:none; margin-top:8px;">
            <div class="row" style="grid-template-columns:1fr 1fr;">
              <div>
                <label for="custom-provider">Provider</label>
                <select id="custom-provider">
                  <option value="newapi">newapi</option>
                  <option value="openrouter">openrouter</option>
                  <option value="google">google 官方</option>
                  <option value="anthropic">claude 官方</option>
                </select>
              </div>
              <div>
                <label for="custom-model-id">模型ID</label>
                <input id="custom-model-id" placeholder="如: gpt-4o-mini" />
              </div>
            </div>
            <label for="custom-api-base" style="margin-top:8px;">API Base（仅newapi时需要）</label>
            <input id="custom-api-base" placeholder="如: https://your-newapi-domain/v1" />
            <div style="font-size:11px;color:#5b6978;margin-top:6px;">
              Key 不在前端填写，统一从后端环境变量读取（更安全）。
            </div>
          </div>
        </div>
      </section>
      <section class="section" style="margin-bottom:0;">
        <h3>番茄数据看板与发布自动化（CDP）</h3>
        <div class="row" style="grid-template-columns:1fr 1fr 1fr; gap:8px;">
          <div class="chip" id="kpi-gen-calls">生成调用: 0</div>
          <div class="chip" id="kpi-gen-chapters">生成章节: 0</div>
          <div class="chip" id="kpi-publish-rate">发布成功率: 0%</div>
        </div>
        <div class="row" style="grid-template-columns:1fr auto; margin-top:8px;">
          <input id="cdp-url" placeholder="CDP地址，如：http://127.0.0.1:9222" />
          <button id="refresh-dashboard-btn" class="btn btn-soft">刷新看板</button>
        </div>
        <div style="display:flex;justify-content:flex-end;margin-top:6px;">
          <button id="probe-cdp-btn" class="btn btn-soft">CDP检测</button>
        </div>
        <input id="fanqie-create-url" style="margin-top:8px;" placeholder="番茄新建章节页面URL（已登录浏览器可访问）" />
        <div class="row" style="grid-template-columns:1fr auto auto; margin-top:8px;">
          <button id="fill-from-first-btn" class="btn btn-soft">用首章填充</button>
          <button id="dry-run-publish-btn" class="btn btn-soft">发布演练</button>
          <button id="publish-now-btn" class="btn btn-soft">立即发布</button>
        </div>
        <div class="row" style="grid-template-columns:1fr 1fr auto auto; margin-top:8px;">
          <input id="schedule-at" type="datetime-local" />
          <input id="schedule-retries" type="number" min="0" value="2" placeholder="重试次数" />
          <button id="schedule-publish-btn" class="btn btn-soft">加入队列</button>
          <button id="refresh-queue-btn" class="btn btn-soft">刷新队列</button>
        </div>
        <input id="publish-title" style="margin-top:8px;" placeholder="发布章节标题" />
        <textarea id="publish-content" rows="4" placeholder="发布章节正文"></textarea>
        <div id="publish-status" class="status"></div>
        <div id="queue-list" style="margin-top:8px;font-size:12px;color:#425466;"></div>
      </section>
    </div>
  </div>

  <div id="diff-modal" class="settings-modal">
    <div class="settings-card">
      <div class="title" style="margin-bottom:10px;">
        <h2 style="font-size:20px;">敏感词替换预览</h2>
        <button id="close-diff-btn" class="btn btn-soft">关闭</button>
      </div>
      <div class="row" style="grid-template-columns:1fr 1fr; gap:10px;">
        <div>
          <label>替换前</label>
          <textarea id="diff-before" rows="12" readonly></textarea>
        </div>
        <div>
          <label>替换后</label>
          <textarea id="diff-after" rows="12" readonly></textarea>
        </div>
      </div>
      <div id="diff-rules" style="margin-top:8px;max-height:180px;overflow:auto;border:1px solid #d7e2ef;border-radius:10px;padding:8px;"></div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px;">
        <button id="cancel-diff-btn" class="btn btn-soft">取消</button>
        <button id="confirm-diff-btn" class="btn btn-soft">确认替换</button>
      </div>
    </div>
  </div>

    <script>
    const state = {
      chapters: [],
      questions: [],
      answers: {},
      chapterPage: 1,
      chapterPageSize: 20,
      qualityReport: null,
      chapterVersions: {}
    };
    let pendingSanitize = null;
    const STORAGE_KEY = 'novel_console_draft_v1';
    const SUGGESTIONS = {
      genre: ['玄幻升级流', '都市悬疑', '现实言情'],
      protagonist: ['落魄调查记者', '退役女特警', '底层程序员'],
      world_conflict: ['财阀垄断与底层反抗', '宗门内斗与外族入侵', 'AI监管与人类自由冲突'],
      tone_pace: ['冷峻克制+快节奏', '热血爽感+高反转', '细腻慢热+情感推进'],
      length_target: ['10章，每章3000字', '20章，每章3500字', '30章，每章4000字']
    };

    function fmt(text) {
      return (text || '').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>');
    }

    function formatChapterContent(content) {
      const raw = (content || '').trim();
      if (!raw) return '';
      const escaped = raw.replace(/</g, '&lt;').replace(/>/g, '&gt;');
      const blocks = escaped.split(/\n\s*\n/).map(x => x.trim()).filter(Boolean);
      return blocks.map((b) => {
        if (/^第\s*[一二三四五六七八九十百千万\d]+\s*[章节卷]/.test(b)) {
          return `<h4 style="margin:10px 0 8px;color:#1f3550;font-size:15px;">${b}</h4>`;
        }
        const oneLine = b.replace(/\n+/g, ' ').trim();
        const isDialogue = /[“”"「」]/.test(oneLine);
        if (isDialogue) {
          return `<p style="margin:0 0 10px;padding-left:10px;border-left:2px solid #d5e2f0;line-height:1.9;color:#223548;">${oneLine}</p>`;
        }
        return `<p style="margin:0 0 10px;text-indent:2em;line-height:1.95;color:#223548;">${oneLine}</p>`;
      }).join('');
    }

    function countTextNoPunct(text) {
      const raw = (text || '');
      return raw
        .replace(/[\s\p{P}\p{S}]/gu, '')
        .length;
    }

    async function safeJson(res) {
      const text = await res.text();
      try {
        return JSON.parse(text);
      } catch (_) {
        return { success: false, error: text || `HTTP ${res.status}` };
      }
    }

    function parseJsonArray(text) {
      const raw = (text || '').trim();
      if (!raw) return [];
      try {
        const v = JSON.parse(raw);
        return Array.isArray(v) ? v : [];
      } catch (_) {
        return [];
      }
    }

    function getStyleStrength() {
      return (document.getElementById('style-strength').value || 'medium').trim();
    }

    function getPublishThresholds() {
      return {
        readability: Number(document.getElementById('threshold-readability').value || 65),
        coherence: Number(document.getElementById('threshold-coherence').value || 65),
        hookRate: Number(document.getElementById('threshold-hook-rate').value || 60),
      };
    }

    function checkQualityThresholds() {
      const s = state.qualityReport?.summary;
      if (!s) return { ok: true, reason: '' };
      const t = getPublishThresholds();
      if (Number(s.avg_readability || 0) < t.readability) {
        return { ok: false, reason: `可读性 ${s.avg_readability} < 阈值 ${t.readability}` };
      }
      if (Number(s.avg_coherence || 0) < t.coherence) {
        return { ok: false, reason: `连贯性 ${s.avg_coherence} < 阈值 ${t.coherence}` };
      }
      const hookRate = Number(s.hook_rate || 0) * 100;
      if (hookRate < t.hookRate) {
        return { ok: false, reason: `钩子率 ${hookRate.toFixed(0)}% < 阈值 ${t.hookRate}%` };
      }
      return { ok: true, reason: '' };
    }

    function pushChapterVersion(index, reason) {
      const ch = state.chapters[index];
      if (!ch) return;
      if (!state.chapterVersions[index]) state.chapterVersions[index] = [];
      state.chapterVersions[index].push({
        at: new Date().toISOString(),
        reason: reason || '内容修改',
        title: ch.title || '',
        content: ch.content || ''
      });
      if (state.chapterVersions[index].length > 20) {
        state.chapterVersions[index] = state.chapterVersions[index].slice(-20);
      }
    }

    function rollbackChapter(index) {
      const rows = state.chapterVersions[index] || [];
      if (!rows.length) return alert('该章节暂无可回滚历史');
      const prev = rows.pop();
      if (!state.chapters[index]) return;
      state.chapters[index].title = prev.title || state.chapters[index].title;
      state.chapters[index].content = prev.content || state.chapters[index].content;
      renderChapters();
      saveDraft();
      alert(`已回滚到：${prev.reason}（${new Date(prev.at).toLocaleString()}）`);
    }

    function applyReplacements(baseText, rules) {
      let out = baseText || '';
      (rules || []).forEach((r) => {
        if (!r.enabled) return;
        const from = String(r.word || '').trim();
        const to = String(r.replace_with || '合规替代表述').trim();
        if (!from) return;
        out = out.split(from).join(to);
      });
      return out;
    }

    function renderDiffRules() {
      const wrap = document.getElementById('diff-rules');
      if (!pendingSanitize || !pendingSanitize.rules?.length) {
        wrap.innerHTML = '<div style="font-size:12px;color:#607080;">无可替换项</div>';
        return;
      }
      wrap.innerHTML = pendingSanitize.rules.map((r, i) => `
        <label style="display:flex;align-items:center;gap:8px;font-size:12px;padding:4px 0;">
          <input type="checkbox" data-rule-index="${i}" ${r.enabled ? 'checked' : ''} style="width:auto;" />
          <span>“${r.word}” → “${r.replace_with}”</span>
        </label>
      `).join('');
      wrap.querySelectorAll('input[data-rule-index]').forEach(el => {
        el.addEventListener('change', () => {
          const idx = Number(el.getAttribute('data-rule-index'));
          if (!pendingSanitize || !pendingSanitize.rules[idx]) return;
          pendingSanitize.rules[idx].enabled = !!el.checked;
          const after = applyReplacements(pendingSanitize.before, pendingSanitize.rules);
          pendingSanitize.after = after;
          document.getElementById('diff-after').value = after;
        });
      });
    }

    function getCustomModelPayload() {
      const enabled = document.getElementById('use-custom-model').checked;
      if (!enabled) return null;
      return {
        provider: document.getElementById('custom-provider').value || 'newapi',
        id: (document.getElementById('custom-model-id').value || '').trim(),
        api_base: (document.getElementById('custom-api-base').value || '').trim()
      };
    }

    function toggleCustomModel() {
      const show = document.getElementById('use-custom-model').checked;
      document.getElementById('custom-model-wrap').style.display = show ? 'block' : 'none';
    }

    function switchLeftTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-tab') === tab);
      });
      document.querySelectorAll('[data-pane]').forEach(node => {
        node.classList.toggle('pane-hidden', node.getAttribute('data-pane') !== tab);
      });
      try {
        localStorage.setItem('novel_left_tab_v1', tab);
      } catch (_) {}
      updateTabHint();
    }

    function updateTabMeta() {
      const core = (document.getElementById('core-prompt').value || '').trim();
      const genre = (document.getElementById('genre').value || '').trim();
      const basicDone = [core, genre].filter(Boolean).length;
      document.getElementById('meta-basic').textContent = `${basicDone}/2`;

      const guideTotal = state.questions.length || 5;
      let guideDone = 0;
      state.questions.forEach(q => {
        if ((state.answers[q.id] || '').trim()) guideDone += 1;
      });
      document.getElementById('meta-guide').textContent = `${guideDone}/${guideTotal}`;

      const profession = (document.getElementById('profession-system').value || '').trim();
      const roles = parseJsonArray(document.getElementById('role-cards').value);
      const orgs = parseJsonArray(document.getElementById('org-cards').value);
      const foreshadows = parseJsonArray(document.getElementById('foreshadows').value);
      let advDone = 0;
      if (profession) advDone += 1;
      if (roles.length) advDone += 1;
      if (orgs.length) advDone += 1;
      if (foreshadows.length) advDone += 1;
      document.getElementById('meta-advanced').textContent = `${advDone}/4`;
      updateTabHint();
    }

    function updateTabHint() {
      const active = document.querySelector('.tab-btn.active')?.getAttribute('data-tab') || 'basic';
      const hint = document.getElementById('tab-hint');
      const core = (document.getElementById('core-prompt').value || '').trim();
      const genre = (document.getElementById('genre').value || '').trim();
      const missingBasic = [];
      if (!core) missingBasic.push('核心创意');
      if (!genre) missingBasic.push('题材风格');

      const missingGuide = [];
      state.questions.forEach((q) => {
        if (!(state.answers[q.id] || '').trim()) missingGuide.push(q.question);
      });

      const missingAdv = [];
      if (!(document.getElementById('profession-system').value || '').trim()) missingAdv.push('职业体系描述');
      if (!parseJsonArray(document.getElementById('role-cards').value).length) missingAdv.push('角色卡');
      if (!parseJsonArray(document.getElementById('org-cards').value).length) missingAdv.push('组织卡');
      if (!parseJsonArray(document.getElementById('foreshadows').value).length) missingAdv.push('伏笔');

      if (active === 'basic') {
        hint.textContent = missingBasic.length ? `基础待补：${missingBasic.join('、')}` : '基础信息已齐全';
      } else if (active === 'guide') {
        hint.textContent = missingGuide.length ? `引导待补：${missingGuide.slice(0, 2).join('、')}${missingGuide.length > 2 ? '...' : ''}` : '5问已完成';
      } else {
        hint.textContent = missingAdv.length ? `世界观待补：${missingAdv.join('、')}` : '世界观结构已齐全';
      }
    }

    function saveDraft() {
      try {
        const payload = {
          genre: document.getElementById('genre')?.value || '',
          corePrompt: document.getElementById('core-prompt')?.value || '',
          stylePrompt: document.getElementById('style-prompt')?.value || '',
          customPrompt: document.getElementById('custom-prompt')?.value || '',
          styleStrength: getStyleStrength(),
          chapterMinWords: Number(document.getElementById('chapter-min-words')?.value || 3000),
          chapterMaxWords: Number(document.getElementById('chapter-max-words')?.value || 5000),
          thresholdReadability: Number(document.getElementById('threshold-readability')?.value || 65),
          thresholdCoherence: Number(document.getElementById('threshold-coherence')?.value || 65),
          thresholdHookRate: Number(document.getElementById('threshold-hook-rate')?.value || 60),
          analysisNotes: document.getElementById('analysis-notes')?.value || '',
          continueBatchCount: Number(document.getElementById('continue-batch-count')?.value || 3),
          professionPreset: document.getElementById('profession-preset')?.value || '',
          professionSystem: document.getElementById('profession-system')?.value || '',
          roleCardsRaw: document.getElementById('role-cards')?.value || '',
          orgCardsRaw: document.getElementById('org-cards')?.value || '',
          foreshadowsRaw: document.getElementById('foreshadows')?.value || '',
          useCustomModel: document.getElementById('use-custom-model')?.checked || false,
          customProvider: document.getElementById('custom-provider')?.value || 'newapi',
          customModelId: document.getElementById('custom-model-id')?.value || '',
          customApiBase: document.getElementById('custom-api-base')?.value || '',
          cdpUrl: document.getElementById('cdp-url')?.value || '',
          fanqieCreateUrl: document.getElementById('fanqie-create-url')?.value || '',
          publishTitle: document.getElementById('publish-title')?.value || '',
          publishContent: document.getElementById('publish-content')?.value || '',
          scheduleAt: document.getElementById('schedule-at')?.value || '',
          scheduleRetries: Number(document.getElementById('schedule-retries')?.value || 2),
          model: document.getElementById('model-select')?.value || '',
          answers: state.answers || {},
          title: document.getElementById('novel-title')?.textContent || '未生成',
          chapters: state.chapters || [],
          chapterVersions: state.chapterVersions || {}
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
      } catch (_) {}
    }

    function loadDraft() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const d = JSON.parse(raw);
        if (d.genre) document.getElementById('genre').value = d.genre;
        if (d.corePrompt) document.getElementById('core-prompt').value = d.corePrompt;
        if (d.stylePrompt) document.getElementById('style-prompt').value = d.stylePrompt;
        if (d.customPrompt) document.getElementById('custom-prompt').value = d.customPrompt;
        if (d.styleStrength) document.getElementById('style-strength').value = d.styleStrength;
        if (d.chapterMinWords) document.getElementById('chapter-min-words').value = d.chapterMinWords;
        if (d.chapterMaxWords) document.getElementById('chapter-max-words').value = d.chapterMaxWords;
        if (typeof d.thresholdReadability === 'number') document.getElementById('threshold-readability').value = d.thresholdReadability;
        if (typeof d.thresholdCoherence === 'number') document.getElementById('threshold-coherence').value = d.thresholdCoherence;
        if (typeof d.thresholdHookRate === 'number') document.getElementById('threshold-hook-rate').value = d.thresholdHookRate;
        if (d.analysisNotes) document.getElementById('analysis-notes').value = d.analysisNotes;
        if (typeof d.continueBatchCount === 'number') document.getElementById('continue-batch-count').value = d.continueBatchCount;
        if (d.professionPreset) document.getElementById('profession-preset').value = d.professionPreset;
        if (d.professionSystem) document.getElementById('profession-system').value = d.professionSystem;
        if (d.roleCardsRaw) document.getElementById('role-cards').value = d.roleCardsRaw;
        if (d.orgCardsRaw) document.getElementById('org-cards').value = d.orgCardsRaw;
        if (d.foreshadowsRaw) document.getElementById('foreshadows').value = d.foreshadowsRaw;
        document.getElementById('use-custom-model').checked = !!d.useCustomModel;
        if (d.customProvider) document.getElementById('custom-provider').value = d.customProvider;
        if (d.customModelId) document.getElementById('custom-model-id').value = d.customModelId;
        if (d.customApiBase) document.getElementById('custom-api-base').value = d.customApiBase;
        if (d.cdpUrl) document.getElementById('cdp-url').value = d.cdpUrl;
        if (d.fanqieCreateUrl) document.getElementById('fanqie-create-url').value = d.fanqieCreateUrl;
        if (d.publishTitle) document.getElementById('publish-title').value = d.publishTitle;
        if (d.publishContent) document.getElementById('publish-content').value = d.publishContent;
        if (d.scheduleAt) document.getElementById('schedule-at').value = d.scheduleAt;
        if (typeof d.scheduleRetries === 'number') document.getElementById('schedule-retries').value = d.scheduleRetries;
        toggleCustomModel();
        if (d.answers && typeof d.answers === 'object') state.answers = d.answers;
        if (Array.isArray(d.chapters) && d.chapters.length) state.chapters = d.chapters;
        if (d.chapterVersions && typeof d.chapterVersions === 'object') state.chapterVersions = d.chapterVersions;
        if (d.title) document.getElementById('novel-title').textContent = d.title;
      } catch (_) {}
    }

    function completionStats() {
      const corePrompt = (document.getElementById('core-prompt').value || '').trim();
      let filled = 0;
      state.questions.forEach(q => {
        if ((state.answers[q.id] || '').trim()) filled += 1;
      });
      const ready = corePrompt.length > 0 && filled >= 2;
      return { corePrompt, filled, total: state.questions.length || 5, ready };
    }

    function updateGenerateHint() {
      const btn = document.getElementById('generate-btn');
      const status = document.getElementById('status');
      const { filled, total, ready } = completionStats();
      if (ready) {
        btn.textContent = '生成小说';
        status.textContent = `已满足建议条件：核心创意 + ${filled}/${total} 问。可直接生成。`;
        status.className = 'status good';
      } else {
        btn.textContent = '继续补充后生成（可直接生成）';
        status.textContent = `建议先填写核心创意并至少完成2个问题（当前 ${filled}/${total}）。`;
        status.className = 'status warn';
      }
      saveDraft();
      updateTabMeta();
    }

    let genProgressTimer = null;
    function startProgress(messagePrefix) {
      const status = document.getElementById('status');
      const wrap = document.getElementById('status-progress');
      const bar = document.getElementById('status-progress-bar');
      const stages = ['请求模型中', '生成剧情结构', '扩展章节细节', '润色与校验'];
      let pct = 6;
      let tick = 0;
      wrap.classList.add('show');
      bar.style.width = `${pct}%`;
      status.textContent = `${messagePrefix || '处理中'} · ${stages[0]} (${pct}%)`;
      if (genProgressTimer) clearInterval(genProgressTimer);
      genProgressTimer = setInterval(() => {
        const cap = 92;
        if (pct < cap) pct += Math.max(1, Math.floor((cap - pct) / 6));
        tick += 1;
        const stage = stages[Math.min(stages.length - 1, Math.floor(tick / 3))];
        bar.style.width = `${pct}%`;
        status.textContent = `${messagePrefix || '处理中'} · ${stage} (${pct}%)`;
      }, 850);
    }

    function finishProgress(finalText, ok = true) {
      const status = document.getElementById('status');
      const wrap = document.getElementById('status-progress');
      const bar = document.getElementById('status-progress-bar');
      if (genProgressTimer) {
        clearInterval(genProgressTimer);
        genProgressTimer = null;
      }
      bar.style.width = '100%';
      status.textContent = finalText || (ok ? '完成' : '失败');
      status.className = ok ? 'status good' : 'status warn';
      setTimeout(() => {
        wrap.classList.remove('show');
        bar.style.width = '0%';
      }, 900);
    }

    async function loadModels() {
      const sel = document.getElementById('model-select');
      sel.innerHTML = '<option>加载中...</option>';
      try {
        const res = await fetch('/models');
        const data = await safeJson(res);
        if (!data.success) throw new Error(data.error || '模型加载失败');
        sel.innerHTML = '';
        (data.models || []).forEach((m, i) => {
          const opt = document.createElement('option');
          opt.value = m.uid || '';
          opt.textContent = m.name || m.id || ('model-' + i);
          sel.appendChild(opt);
        });
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (raw) {
            const d = JSON.parse(raw);
            if (d.model) sel.value = d.model;
          }
        } catch (_) {}
      } catch (err) {
        sel.innerHTML = '<option value="">模型加载失败</option>';
      }
      updateTabMeta();
      await loadRuntimeStatus();
    }

    async function loadRuntimeStatus() {
      const node = document.getElementById('runtime-hint');
      try {
        const res = await fetch('/runtime/status');
        const data = await safeJson(res);
        if (!data.success) throw new Error();
        node.textContent = `Key状态：OpenRouter ${data.openrouter_configured ? '已配' : '未配'} / NewAPI ${data.newapi_configured ? '已配' : '未配'} / Google ${data.google_configured ? '已配' : '未配'} / Claude ${data.anthropic_configured ? '已配' : '未配'}`;
      } catch (_) {
        node.textContent = 'Key状态：无法获取';
      }
    }

    async function refreshDashboard() {
      try {
        const res = await fetch('/dashboard/summary');
        const data = await safeJson(res);
        if (!data.success) throw new Error(data.error || 'dashboard error');
        const s = data.stats || {};
        const attempts = Number(s.published_attempts || 0);
        const success = Number(s.published_success || 0);
        const rate = attempts ? Math.round((success / attempts) * 100) : 0;
        document.getElementById('kpi-gen-calls').textContent = `生成调用: ${s.generated_calls || 0}`;
        document.getElementById('kpi-gen-chapters').textContent = `生成章节: ${s.generated_chapters || 0}`;
        document.getElementById('kpi-publish-rate').textContent = `发布成功率: ${rate}%`;
        renderQueue(data.publish_queue || []);
      } catch (_) {}
    }

    async function probeCdp() {
      const cdpUrl = (document.getElementById('cdp-url').value || '').trim();
      const status = document.getElementById('publish-status');
      if (!cdpUrl) return alert('请先填写CDP地址');
      status.textContent = 'CDP检测中...';
      try {
        const res = await fetch('/publish/fanqie/probe', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ cdp_url: cdpUrl, timeout_ms: 8000 })
        });
        const data = await safeJson(res);
        if (!data.success) throw new Error(data.error || '检测失败');
        const pages = (data.pages || []).slice(0, 5).map((u, i) => `${i + 1}. ${u}`).join(' | ');
        status.textContent = `CDP可用：${data.detail}${pages ? `；页面：${pages}` : ''}`;
      } catch (e) {
        status.textContent = `CDP不可用：${e.message}`;
      }
    }

    function renderQueue(items) {
      const node = document.getElementById('queue-list');
      if (!items.length) {
        node.textContent = '发布队列为空';
        return;
      }
      const rows = items.slice(0, 8).map(j =>
        `<div style="padding:4px 0;border-bottom:1px dashed #d6e1ee;">[${j.status}] ${j.title || ''} · 重试${j.attempts}/${j.max_retries} · 下次执行: ${j.next_run_at || '-'} </div>`
      ).join('');
      node.innerHTML = rows;
    }

    function fillPublishFromFirst() {
      if (!state.chapters.length) return alert('暂无章节可填充');
      const ch = state.chapters[0];
      document.getElementById('publish-title').value = ch.title || '未命名章节';
      document.getElementById('publish-content').value = ch.content || '';
      saveDraft();
    }

    async function publishFanqie(dryRun = false) {
      const cdpUrl = (document.getElementById('cdp-url').value || '').trim();
      const createUrl = (document.getElementById('fanqie-create-url').value || '').trim();
      const chapterTitle = (document.getElementById('publish-title').value || '').trim();
      const chapterContent = (document.getElementById('publish-content').value || '').trim();
      if (!cdpUrl || !createUrl || !chapterTitle || !chapterContent) {
        return alert('请先填写CDP地址、发布URL、章节标题与正文');
      }
      const netWords = countTextNoPunct(chapterContent);
      const minWords = Number(document.getElementById('chapter-min-words').value || 3000);
      const hasHook = /[？?！!…\.。]$/.test(chapterContent.trim()) || /下章|下一章|未完|悬念|转折/.test(chapterContent);
      if (!dryRun) {
        const q = checkQualityThresholds();
        if (!q.ok) return alert(`发布拦截：${q.reason}`);
        if (netWords < minWords) return alert(`发布拦截：净字数 ${netWords}，低于目标最小字数 ${minWords}`);
        if (!hasHook) return alert('发布拦截：未检测到结尾钩子（建议在结尾增加悬念引导）');
      }
      const status = document.getElementById('publish-status');
      status.textContent = dryRun ? '发布演练中...' : '发布执行中...';
      try {
        const res = await fetch('/publish/fanqie', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            cdp_url: cdpUrl,
            create_url: createUrl,
            chapter_title: chapterTitle,
            chapter_content: chapterContent,
            dry_run: dryRun,
            auto_publish: !dryRun
          })
        });
        const data = await safeJson(res);
        if (!data.success) throw new Error(data.error || '发布失败');
        status.textContent = `${dryRun ? '演练完成' : '发布完成'}：${data.task?.detail || ''}`;
      } catch (e) {
        status.textContent = `失败：${e.message}`;
      } finally {
        saveDraft();
        refreshDashboard();
      }
    }

    async function schedulePublish() {
      const cdpUrl = (document.getElementById('cdp-url').value || '').trim();
      const createUrl = (document.getElementById('fanqie-create-url').value || '').trim();
      const chapterTitle = (document.getElementById('publish-title').value || '').trim();
      const chapterContent = (document.getElementById('publish-content').value || '').trim();
      const scheduleAt = document.getElementById('schedule-at').value;
      const retries = Number(document.getElementById('schedule-retries').value || 2);
      if (!cdpUrl || !createUrl || !chapterTitle || !chapterContent) {
        return alert('请先填写CDP地址、发布URL、章节标题与正文');
      }
      const q = checkQualityThresholds();
      if (!q.ok) return alert(`入队拦截：${q.reason}`);
      const runAtEpoch = scheduleAt ? Math.floor(new Date(scheduleAt).getTime() / 1000) : null;
      const status = document.getElementById('publish-status');
      status.textContent = '加入队列中...';
      try {
        const res = await fetch('/publish/fanqie/schedule', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            cdp_url: cdpUrl,
            create_url: createUrl,
            chapter_title: chapterTitle,
            chapter_content: chapterContent,
            run_at_epoch: runAtEpoch,
            max_retries: retries
          })
        });
        const data = await safeJson(res);
        if (!data.success) throw new Error(data.error || '排队失败');
        status.textContent = `已入队：${data.job?.job_id || ''}`;
      } catch (e) {
        status.textContent = `失败：${e.message}`;
      } finally {
        saveDraft();
        refreshDashboard();
      }
    }

    async function testModels() {
      const btn = document.getElementById('test-models-btn');
      const tip = document.getElementById('model-test-status');
      const sel = document.getElementById('model-select');
      btn.disabled = true;
      tip.textContent = '检测中...';
      try {
        const res = await fetch('/models/health');
        const data = await safeJson(res);
        if (!data.success) throw new Error(data.error || '检测失败');
        const map = {};
        (data.results || []).forEach(item => { map[item.uid] = item; });
        Array.from(sel.options).forEach(opt => {
          const item = map[opt.value];
          if (!item) return;
          const base = opt.textContent.replace(/^✅\s|^❌\s/, '');
          if (item.ok) {
            opt.textContent = `✅ ${base}`;
            opt.style.color = '#067647';
            opt.title = '连接正常';
          } else {
            opt.textContent = `❌ ${base}`;
            opt.style.color = '#b42318';
            opt.title = item.detail || '连接失败';
          }
        });
        const okCount = (data.results || []).filter(x => x.ok).length;
        tip.textContent = `模型可用 ${okCount}/${(data.results || []).length}`;
        tip.className = okCount ? 'chip ok' : 'chip bad';
      } catch (err) {
        tip.textContent = `检测失败：${err.message}`;
        tip.className = 'chip bad';
      } finally {
        btn.disabled = false;
      }
    }

    async function loadQuestions() {
      const res = await fetch('/workflow/questions');
      const data = await safeJson(res);
      state.questions = data.questions || [];
      renderQuestionOverview();
      updateGenerateHint();
      updateTabMeta();
    }

    function renderQuestionOverview() {
      const total = state.questions.length || 1;
      let completed = 0;
      let nextIndex = -1;
      state.questions.forEach((q, i) => {
        const v = (state.answers[q.id] || '').trim();
        if (v) completed += 1;
        if (nextIndex === -1 && !v) nextIndex = i;
      });
      const activeIndex = nextIndex === -1 ? total - 1 : nextIndex;
      document.getElementById('step-indicator').textContent = `已完成 ${completed}/${total}`;
      document.getElementById('progress-bar').style.width = `${Math.round((completed / total) * 100)}%`;

      const body = document.getElementById('wizard-body');
      if (!state.questions.length) {
        body.innerHTML = '<p class="bad" style="font-size:12px;">问题加载失败</p>';
        return;
      }
      body.innerHTML = '';
      state.questions.forEach((q, i) => {
        const wrap = document.createElement('div');
        wrap.className = `q-item ${i === activeIndex ? 'active' : ''}`;
        const val = state.answers[q.id] || '';
        const hints = SUGGESTIONS[q.id] || [];
        const chips = hints.map(x => `<button type="button" class="chip-btn" data-fill="${q.id}" data-value="${x}">${x}</button>`).join('');
        wrap.innerHTML = `
          <div class="q-head">
            <div class="q-title">Q${i + 1}. ${q.question}</div>
            <span class="q-tag">${val.trim() ? '已填写' : (i === activeIndex ? '建议下一题' : '可选')}</span>
          </div>
          <textarea data-qid="${q.id}" rows="2" placeholder="${q.hint || ''}">${val}</textarea>
          <div class="chips">${chips}</div>
        `;
        body.appendChild(wrap);
      });

      body.querySelectorAll('textarea[data-qid]').forEach(el => {
        el.addEventListener('input', (e) => {
          const qid = e.target.getAttribute('data-qid');
          state.answers[qid] = e.target.value;
          renderQuestionOverview();
          updateGenerateHint();
          updateTabMeta();
        });
      });

      body.querySelectorAll('button[data-fill]').forEach(el => {
        el.addEventListener('click', () => {
          const qid = el.getAttribute('data-fill');
          const value = el.getAttribute('data-value') || '';
          state.answers[qid] = value;
          renderQuestionOverview();
          updateGenerateHint();
          updateTabMeta();
        });
      });
    }

    function renderChapters() {
      const list = document.getElementById('result-list');
      const pager = document.getElementById('chapter-pagination');
      const toc = document.getElementById('chapter-toc');
      list.innerHTML = '';
      pager.innerHTML = '';
      toc.innerHTML = '';
      if (!state.chapters.length) {
        list.innerHTML = '<div class="empty">生成后将在这里展示章节内容。可对任意章节执行扩写。</div>';
        return;
      }
      const total = state.chapters.length;
      const pageSize = state.chapterPageSize;
      const totalPages = Math.max(1, Math.ceil(total / pageSize));
      if (state.chapterPage > totalPages) state.chapterPage = totalPages;
      const start = (state.chapterPage - 1) * pageSize;
      const end = Math.min(start + pageSize, total);
      const pageItems = state.chapters.slice(start, end);
      toc.innerHTML = `<span class="chip">目录（当前页 ${start + 1}-${end}）</span>` + pageItems.map((ch, i) => {
        const idx = start + i;
        return `<button class="chip-btn" data-toc="${idx}">${idx + 1}.${(ch.title || `第${idx + 1}章`).slice(0, 16)}</button>`;
      }).join('');

      if (totalPages > 1) {
        const prevDisabled = state.chapterPage <= 1 ? 'disabled' : '';
        const nextDisabled = state.chapterPage >= totalPages ? 'disabled' : '';
        pager.innerHTML = `
          <button id="pager-prev" class="btn btn-soft" ${prevDisabled}>上一页</button>
          <span class="chip">第 ${state.chapterPage}/${totalPages} 页 · 共 ${total} 章</span>
          <button id="pager-next" class="btn btn-soft" ${nextDisabled}>下一页</button>
        `;
      } else {
        pager.innerHTML = `<span class="chip">共 ${total} 章</span>`;
      }

      pageItems.forEach((ch, idxLocal) => {
        const idx = start + idxLocal;
        const bodyId = `chapter-body-${idx}`;
        const card = document.createElement('section');
        const wordCount = countTextNoPunct(ch.content);
        const qa = state.qualityReport?.chapters?.[idx] || null;
        const maxWords = Number(document.getElementById('chapter-max-words').value || 5000);
        const isHigh = wordCount > maxWords;
        const wcColor = isHigh ? '#b42318' : '#067647';
        card.className = 'chapter';
        const auditBadges = qa ? `
          <span class="chip" style="margin-left:6px;color:${qa.sensitive_hits?.length ? '#b42318' : '#067647'};">敏感词 ${qa.sensitive_hits?.length || 0}</span>
          <span class="chip" style="margin-left:6px;color:${qa.hook_ok ? '#067647' : '#9a6700'};">钩子 ${qa.hook_ok ? '通过' : '缺失'}</span>
        ` : '';
        card.innerHTML = `
          <div class="chapter-hd">
            <h3>${ch.title || ('第' + (idx + 1) + '章')} <span class="chip" style="margin-left:6px;color:${wcColor};">净字数 ${wordCount}</span>${auditBadges}</h3>
            <div style="display:flex;gap:6px;">
              <button data-toggle="${idx}" data-target="${bodyId}" class="btn btn-soft">展开</button>
              <button data-rollback="${idx}" class="btn btn-soft">回滚</button>
              <button data-sanitize="${idx}" class="btn btn-soft">敏感词替换</button>
              <button data-expand="${idx}" class="btn btn-soft">扩写本章</button>
            </div>
          </div>
          <div id="${bodyId}" class="chapter-bd" style="display:none;">${formatChapterContent(ch.content)}</div>
        `;
        list.appendChild(card);
      });
      const prevBtn = document.getElementById('pager-prev');
      if (prevBtn) prevBtn.addEventListener('click', () => { state.chapterPage -= 1; renderChapters(); });
      const nextBtn = document.getElementById('pager-next');
      if (nextBtn) nextBtn.addEventListener('click', () => { state.chapterPage += 1; renderChapters(); });
      toc.querySelectorAll('[data-toc]').forEach(btn => {
        btn.addEventListener('click', () => {
          const idx = Number(btn.getAttribute('data-toc'));
          const body = document.getElementById(`chapter-body-${idx}`);
          const toggleBtn = list.querySelector(`[data-toggle="${idx}"]`);
          if (body && toggleBtn) {
            body.style.display = 'block';
            toggleBtn.textContent = '收起';
            body.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        });
      });
      list.querySelectorAll('[data-rollback]').forEach(btn => {
        btn.addEventListener('click', () => {
          rollbackChapter(Number(btn.getAttribute('data-rollback')));
        });
      });
      list.querySelectorAll('[data-toggle]').forEach(btn => {
        btn.addEventListener('click', () => {
          const targetId = btn.getAttribute('data-target');
          const body = document.getElementById(targetId);
          if (!body) return;
          const hidden = body.style.display === 'none';
          body.style.display = hidden ? 'block' : 'none';
          btn.textContent = hidden ? '收起' : '展开';
        });
      });
      list.querySelectorAll('[data-expand]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const i = Number(btn.getAttribute('data-expand'));
          const target = state.chapters[i];
          if (!target) return;
          btn.disabled = true;
          btn.textContent = '扩写中...';
          try {
            const res = await fetch('/generate', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                prompt: `${target.title}\n\n${target.content}`,
                mode: 'expand',
                genre: (document.getElementById('genre').value || '').trim(),
                model: document.getElementById('model-select').value || null,
                style_strength: getStyleStrength(),
                custom_model: getCustomModelPayload()
              })
            });
            const data = await safeJson(res);
            if (!data.success || !data.chapters || !data.chapters.length) throw new Error(data.error || '扩写失败');
            pushChapterVersion(i, '扩写前');
            state.chapters[i].content = data.chapters[0].content;
            if (data.quality_report) state.qualityReport = data.quality_report;
            renderChapters();
            renderQualitySummary();
            saveDraft();
          } catch (err) {
            alert(err.message);
          } finally {
            btn.disabled = false;
            btn.textContent = '扩写本章';
          }
        });
      });
      list.querySelectorAll('[data-sanitize]').forEach(btn => {
        btn.addEventListener('click', () => {
          const i = Number(btn.getAttribute('data-sanitize'));
          const qaRow = state.qualityReport?.chapters?.[i];
          if (!qaRow || !qaRow.sensitive_suggestions || !qaRow.sensitive_suggestions.length) {
            return alert('该章节未检测到敏感词');
          }
          const before = state.chapters[i].content || '';
          const rules = (qaRow.sensitive_suggestions || []).map((it) => ({
            word: String(it.word || '').trim(),
            replace_with: String(it.replace_with || '合规替代表述').trim(),
            enabled: true
          })).filter(x => x.word);
          const after = applyReplacements(before, rules);
          pendingSanitize = { index: i, before, after, rules };
          document.getElementById('diff-before').value = before;
          document.getElementById('diff-after').value = after;
          renderDiffRules();
          document.getElementById('diff-modal').classList.add('show');
        });
      });
    }

    function renderQualitySummary() {
      const node = document.getElementById('quality-summary');
      const s = state.qualityReport?.summary;
      if (!s) {
        node.style.display = 'none';
        node.textContent = '';
        return;
      }
      node.style.display = 'inline-block';
      node.textContent = `质量评分：可读性 ${s.avg_readability} / 连贯性 ${s.avg_coherence} / 钩子率 ${(s.hook_rate * 100).toFixed(0)}% / 敏感词命中 ${s.sensitive_hit_count}`;
    }

    async function generate() {
      const btn = document.getElementById('generate-btn');
      const status = document.getElementById('status');
      const corePrompt = (document.getElementById('core-prompt').value || '').trim();
      if (!corePrompt) return alert('请先填写核心创意描述');
      const custom = getCustomModelPayload();
      if (custom && !custom.id) return alert('自定义模型已开启，请填写模型ID');
      btn.disabled = true;
      startProgress('生成中');
      try {
        const res = await fetch('/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            prompt: corePrompt,
            mode: 'generate',
            genre: (document.getElementById('genre').value || '').trim(),
            workflow_answers: state.answers,
            model: document.getElementById('model-select').value || null,
            style_prompt: (document.getElementById('style-prompt').value || '').trim(),
            custom_prompt: (document.getElementById('custom-prompt').value || '').trim(),
            style_strength: getStyleStrength(),
            chapter_min_words: Number(document.getElementById('chapter-min-words').value || 3000),
            chapter_max_words: Number(document.getElementById('chapter-max-words').value || 5000),
            profession_system: {
              preset: (document.getElementById('profession-preset').value || '').trim(),
              description: (document.getElementById('profession-system').value || '').trim()
            },
            role_cards: parseJsonArray(document.getElementById('role-cards').value),
            org_cards: parseJsonArray(document.getElementById('org-cards').value),
            foreshadows: parseJsonArray(document.getElementById('foreshadows').value),
            custom_model: getCustomModelPayload()
          })
        });
        const data = await safeJson(res);
        if (!data.success) throw new Error(data.error || '生成失败');
        document.getElementById('novel-title').textContent = data.title || '未命名小说';
        state.chapters = data.chapters || [];
        state.chapterVersions = {};
        state.qualityReport = data.quality_report || null;
        state.chapterPage = 1;
        renderChapters();
        renderQualitySummary();
        saveDraft();
        finishProgress(`完成：${state.chapters.length} 章`, true);
      } catch (err) {
        finishProgress(`失败：${err.message}`, false);
      } finally {
        btn.disabled = false;
      }
    }

    async function inspirationMode() {
      const corePrompt = (document.getElementById('core-prompt').value || '').trim();
      if (!corePrompt) return alert('请先填写核心创意描述');
      const custom = getCustomModelPayload();
      if (custom && !custom.id) return alert('自定义模型已开启，请填写模型ID');
      const status = document.getElementById('status');
      startProgress('灵感生成中');
      try {
        const res = await fetch('/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            prompt: corePrompt,
            mode: 'inspiration',
            genre: (document.getElementById('genre').value || '').trim(),
            style_prompt: (document.getElementById('style-prompt').value || '').trim(),
            style_strength: getStyleStrength(),
            model: document.getElementById('model-select').value || null,
            custom_model: getCustomModelPayload()
          })
        });
        const data = await safeJson(res);
        if (!data.success) throw new Error(data.error || '灵感生成失败');
        document.getElementById('novel-title').textContent = data.title || '灵感模式';
        state.chapters = data.chapters || [];
        state.chapterVersions = {};
        state.qualityReport = data.quality_report || null;
        state.chapterPage = 1;
        renderChapters();
        renderQualitySummary();
        saveDraft();
        finishProgress('灵感已生成', true);
      } catch (err) {
        finishProgress(`失败：${err.message}`, false);
      }
    }

    async function rewriteByAnalysis() {
      const corePrompt = (document.getElementById('core-prompt').value || '').trim();
      const analysisNotes = (document.getElementById('analysis-notes').value || '').trim();
      if (!corePrompt) return alert('请先填写需要重写的内容或核心创意');
      const custom = getCustomModelPayload();
      if (custom && !custom.id) return alert('自定义模型已开启，请填写模型ID');
      const status = document.getElementById('status');
      startProgress('重写中');
      try {
        const res = await fetch('/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            prompt: corePrompt,
            mode: 'rewrite',
            analysis_notes: analysisNotes,
            genre: (document.getElementById('genre').value || '').trim(),
            style_prompt: (document.getElementById('style-prompt').value || '').trim(),
            style_strength: getStyleStrength(),
            model: document.getElementById('model-select').value || null,
            custom_model: getCustomModelPayload(),
            profession_system: {
              preset: (document.getElementById('profession-preset').value || '').trim(),
              description: (document.getElementById('profession-system').value || '').trim()
            },
            role_cards: parseJsonArray(document.getElementById('role-cards').value),
            org_cards: parseJsonArray(document.getElementById('org-cards').value),
            foreshadows: parseJsonArray(document.getElementById('foreshadows').value)
          })
        });
        const data = await safeJson(res);
        if (!data.success) throw new Error(data.error || '重写失败');
        document.getElementById('novel-title').textContent = data.title || '重写结果';
        state.chapters = data.chapters || [];
        state.chapterVersions = {};
        state.qualityReport = data.quality_report || null;
        state.chapterPage = 1;
        renderChapters();
        renderQualitySummary();
        saveDraft();
        finishProgress('重写完成', true);
      } catch (err) {
        finishProgress(`失败：${err.message}`, false);
      }
    }

    async function continueNextChapter() {
      if (!state.chapters.length) return alert('请先生成至少一章内容');
      const status = document.getElementById('status');
      const novelTitle = (document.getElementById('novel-title').textContent || '').trim();
      startProgress('续写中');
      try {
        const res = await fetch('/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            prompt: (document.getElementById('core-prompt').value || '').trim() || '继续主线剧情',
            mode: 'continue',
            novel_title: novelTitle,
            existing_chapters: state.chapters,
            genre: (document.getElementById('genre').value || '').trim(),
            style_prompt: (document.getElementById('style-prompt').value || '').trim(),
            style_strength: getStyleStrength(),
            chapter_min_words: Number(document.getElementById('chapter-min-words').value || 3000),
            chapter_max_words: Number(document.getElementById('chapter-max-words').value || 5000),
            model: document.getElementById('model-select').value || null,
            custom_model: getCustomModelPayload()
          })
        });
        const data = await safeJson(res);
        if (!data.success) throw new Error(data.error || '续写失败');
        const incoming = data.chapters || [];
        if (!incoming.length) throw new Error('未返回新章节');
        const existedTitles = new Set(state.chapters.map(x => x.title));
        incoming.forEach(ch => {
          if (!existedTitles.has(ch.title)) state.chapters.push(ch);
        });
        if (data.quality_report) state.qualityReport = data.quality_report;
        state.chapterPage = Math.max(1, Math.ceil(state.chapters.length / state.chapterPageSize));
        renderChapters();
        renderQualitySummary();
        saveDraft();
        finishProgress(`续写完成：新增 ${incoming.length} 章`, true);
        return true;
      } catch (err) {
        finishProgress(`失败：${err.message}`, false);
        return false;
      }
    }

    async function continueBatchChapters() {
      const count = Number(document.getElementById('continue-batch-count').value || 1);
      if (count < 1) return alert('批量续写数量至少为1');
      const btn = document.getElementById('continue-batch-btn');
      btn.disabled = true;
      const status = document.getElementById('status');
      let ok = 0;
      for (let i = 0; i < count; i++) {
        status.textContent = `批量续写中 ${i + 1}/${count}...`;
        // eslint-disable-next-line no-await-in-loop
        const one = await continueNextChapter();
        if (one) ok += 1;
      }
      status.textContent = `批量续写完成：成功 ${ok}/${count}`;
      btn.disabled = false;
      saveDraft();
    }

    function exportProjectData() {
      const payload = {
        genre: document.getElementById('genre').value || '',
        corePrompt: document.getElementById('core-prompt').value || '',
        stylePrompt: document.getElementById('style-prompt').value || '',
        customPrompt: document.getElementById('custom-prompt').value || '',
        styleStrength: getStyleStrength(),
        chapterMinWords: Number(document.getElementById('chapter-min-words').value || 3000),
        chapterMaxWords: Number(document.getElementById('chapter-max-words').value || 5000),
        thresholdReadability: Number(document.getElementById('threshold-readability').value || 65),
        thresholdCoherence: Number(document.getElementById('threshold-coherence').value || 65),
        thresholdHookRate: Number(document.getElementById('threshold-hook-rate').value || 60),
        analysisNotes: document.getElementById('analysis-notes').value || '',
        continueBatchCount: Number(document.getElementById('continue-batch-count').value || 3),
        professionPreset: document.getElementById('profession-preset').value || '',
        professionSystem: document.getElementById('profession-system').value || '',
        roleCardsRaw: document.getElementById('role-cards').value || '',
        orgCardsRaw: document.getElementById('org-cards').value || '',
        foreshadowsRaw: document.getElementById('foreshadows').value || '',
        useCustomModel: document.getElementById('use-custom-model').checked || false,
        customProvider: document.getElementById('custom-provider').value || 'newapi',
        customModelId: document.getElementById('custom-model-id').value || '',
        customApiBase: document.getElementById('custom-api-base').value || '',
        model: document.getElementById('model-select').value || '',
        answers: state.answers || {},
        title: document.getElementById('novel-title').textContent || '未生成',
        chapters: state.chapters || [],
        chapterVersions: state.chapterVersions || {}
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `novel-project-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function importProjectData(file) {
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const d = JSON.parse(reader.result || '{}');
          document.getElementById('genre').value = d.genre || '';
          document.getElementById('core-prompt').value = d.corePrompt || '';
          document.getElementById('style-prompt').value = d.stylePrompt || '';
          document.getElementById('custom-prompt').value = d.customPrompt || '';
          document.getElementById('style-strength').value = d.styleStrength || 'medium';
          document.getElementById('chapter-min-words').value = d.chapterMinWords || 3000;
          document.getElementById('chapter-max-words').value = d.chapterMaxWords || 5000;
          document.getElementById('threshold-readability').value = d.thresholdReadability || 65;
          document.getElementById('threshold-coherence').value = d.thresholdCoherence || 65;
          document.getElementById('threshold-hook-rate').value = d.thresholdHookRate || 60;
          document.getElementById('analysis-notes').value = d.analysisNotes || '';
          document.getElementById('continue-batch-count').value = d.continueBatchCount || 3;
          document.getElementById('profession-preset').value = d.professionPreset || '';
          document.getElementById('profession-system').value = d.professionSystem || '';
          document.getElementById('role-cards').value = d.roleCardsRaw || '';
          document.getElementById('org-cards').value = d.orgCardsRaw || '';
          document.getElementById('foreshadows').value = d.foreshadowsRaw || '';
          document.getElementById('use-custom-model').checked = !!d.useCustomModel;
          document.getElementById('custom-provider').value = d.customProvider || 'newapi';
          document.getElementById('custom-model-id').value = d.customModelId || '';
          document.getElementById('custom-api-base').value = d.customApiBase || '';
          toggleCustomModel();
          if (d.answers && typeof d.answers === 'object') state.answers = d.answers;
          if (Array.isArray(d.chapters)) state.chapters = d.chapters;
          if (d.chapterVersions && typeof d.chapterVersions === 'object') state.chapterVersions = d.chapterVersions;
          if (d.title) document.getElementById('novel-title').textContent = d.title;
          renderQuestionOverview();
          renderChapters();
          updateGenerateHint();
          saveDraft();
        } catch (e) {
          alert('导入失败：JSON 格式不正确');
        }
      };
      reader.readAsText(file, 'utf-8');
    }

    document.getElementById('generate-btn').addEventListener('click', generate);
    document.getElementById('continue-next-btn').addEventListener('click', continueNextChapter);
    document.getElementById('continue-batch-btn').addEventListener('click', continueBatchChapters);
    document.getElementById('test-models-btn').addEventListener('click', testModels);
    document.getElementById('inspiration-btn').addEventListener('click', inspirationMode);
    document.getElementById('rewrite-btn').addEventListener('click', rewriteByAnalysis);
    document.getElementById('refresh-dashboard-btn').addEventListener('click', refreshDashboard);
    document.getElementById('probe-cdp-btn').addEventListener('click', probeCdp);
    document.getElementById('fill-from-first-btn').addEventListener('click', fillPublishFromFirst);
    document.getElementById('dry-run-publish-btn').addEventListener('click', () => publishFanqie(true));
    document.getElementById('publish-now-btn').addEventListener('click', () => publishFanqie(false));
    document.getElementById('schedule-publish-btn').addEventListener('click', schedulePublish);
    document.getElementById('refresh-queue-btn').addEventListener('click', refreshDashboard);
    document.getElementById('export-btn').addEventListener('click', exportProjectData);
    document.getElementById('import-btn').addEventListener('click', () => document.getElementById('import-file').click());
    document.getElementById('export-cards-btn').addEventListener('click', () => {
      const cards = {
        roleCards: parseJsonArray(document.getElementById('role-cards').value),
        orgCards: parseJsonArray(document.getElementById('org-cards').value)
      };
      const blob = new Blob([JSON.stringify(cards, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `novel-cards-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);
    });
    document.getElementById('import-cards-btn').addEventListener('click', () => document.getElementById('import-cards-file').click());
    document.getElementById('import-file').addEventListener('change', (e) => {
      const f = e.target.files?.[0];
      if (f) importProjectData(f);
      e.target.value = '';
    });
    document.getElementById('import-cards-file').addEventListener('change', (e) => {
      const f = e.target.files?.[0];
      if (!f) return;
      const r = new FileReader();
      r.onload = () => {
        try {
          const d = JSON.parse(r.result || '{}');
          document.getElementById('role-cards').value = JSON.stringify(d.roleCards || [], null, 2);
          document.getElementById('org-cards').value = JSON.stringify(d.orgCards || [], null, 2);
          saveDraft();
        } catch (_) {
          alert('导入角色/组织卡失败：JSON格式错误');
        }
      };
      r.readAsText(f, 'utf-8');
      e.target.value = '';
    });
    window.addEventListener('error', (e) => {
      const s = document.getElementById('status');
      if (s) s.textContent = `前端异常：${e.message}`;
    });
    document.getElementById('core-prompt').addEventListener('input', updateGenerateHint);
    document.getElementById('genre').addEventListener('input', () => { saveDraft(); updateTabMeta(); });
    document.getElementById('style-prompt').addEventListener('input', saveDraft);
    document.getElementById('custom-prompt').addEventListener('input', saveDraft);
    document.getElementById('style-strength').addEventListener('change', saveDraft);
    document.getElementById('chapter-min-words').addEventListener('input', saveDraft);
    document.getElementById('chapter-max-words').addEventListener('input', saveDraft);
    document.getElementById('threshold-readability').addEventListener('input', saveDraft);
    document.getElementById('threshold-coherence').addEventListener('input', saveDraft);
    document.getElementById('threshold-hook-rate').addEventListener('input', saveDraft);
    document.getElementById('continue-batch-count').addEventListener('input', saveDraft);
    document.getElementById('analysis-notes').addEventListener('input', saveDraft);
    document.getElementById('profession-preset').addEventListener('change', saveDraft);
    document.getElementById('profession-preset').addEventListener('change', (e) => {
      const v = e.target.value;
      const map = {
        cultivation: '修仙境界：炼气、筑基、金丹、元婴、化神。每次突破需要资源、心境与劫难。',
        magic: '魔法等级：学徒、初阶、中阶、高阶、圣阶。法术消耗与精神力上限挂钩。',
        mecha: '机甲军衔：新兵、士官、尉官、校官、将官。军衔决定可调用机型和权限。'
      };
      if (map[v]) document.getElementById('profession-system').value = map[v];
      saveDraft();
    });
    document.getElementById('profession-system').addEventListener('input', () => { saveDraft(); updateTabMeta(); });
    document.getElementById('role-cards').addEventListener('input', () => { saveDraft(); updateTabMeta(); });
    document.getElementById('org-cards').addEventListener('input', () => { saveDraft(); updateTabMeta(); });
    document.getElementById('foreshadows').addEventListener('input', () => { saveDraft(); updateTabMeta(); });
    document.getElementById('model-select').addEventListener('change', () => { saveDraft(); updateTabMeta(); });
    document.getElementById('use-custom-model').addEventListener('change', () => { toggleCustomModel(); saveDraft(); updateTabMeta(); });
    document.getElementById('custom-provider').addEventListener('change', () => { saveDraft(); updateTabMeta(); });
    document.getElementById('custom-model-id').addEventListener('input', () => { saveDraft(); updateTabMeta(); });
    document.getElementById('custom-api-base').addEventListener('input', () => { saveDraft(); updateTabMeta(); });
    document.getElementById('cdp-url').addEventListener('input', saveDraft);
    document.getElementById('fanqie-create-url').addEventListener('input', saveDraft);
    document.getElementById('publish-title').addEventListener('input', saveDraft);
    document.getElementById('publish-content').addEventListener('input', saveDraft);
    document.getElementById('schedule-at').addEventListener('change', saveDraft);
    document.getElementById('schedule-retries').addEventListener('input', saveDraft);
    document.getElementById('open-settings-btn').addEventListener('click', () => {
      document.getElementById('settings-modal').classList.add('show');
    });
    document.getElementById('close-settings-btn').addEventListener('click', () => {
      document.getElementById('settings-modal').classList.remove('show');
    });
    document.getElementById('settings-modal').addEventListener('click', (e) => {
      if (e.target.id === 'settings-modal') document.getElementById('settings-modal').classList.remove('show');
    });
    document.getElementById('close-diff-btn').addEventListener('click', () => {
      document.getElementById('diff-modal').classList.remove('show');
      pendingSanitize = null;
      document.getElementById('diff-rules').innerHTML = '';
    });
    document.getElementById('cancel-diff-btn').addEventListener('click', () => {
      document.getElementById('diff-modal').classList.remove('show');
      pendingSanitize = null;
      document.getElementById('diff-rules').innerHTML = '';
    });
    document.getElementById('confirm-diff-btn').addEventListener('click', () => {
      if (!pendingSanitize) return;
      const enabledCount = (pendingSanitize.rules || []).filter(x => x.enabled).length;
      if (!enabledCount) return alert('请至少勾选一条替换规则');
      pushChapterVersion(pendingSanitize.index, '敏感词替换前');
      state.chapters[pendingSanitize.index].content = pendingSanitize.after;
      document.getElementById('diff-modal').classList.remove('show');
      pendingSanitize = null;
      document.getElementById('diff-rules').innerHTML = '';
      renderChapters();
      saveDraft();
      alert('替换完成，建议再执行一次生成/审核确认。');
    });
    document.getElementById('diff-modal').addEventListener('click', (e) => {
      if (e.target.id === 'diff-modal') {
        document.getElementById('diff-modal').classList.remove('show');
        pendingSanitize = null;
        document.getElementById('diff-rules').innerHTML = '';
      }
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        document.getElementById('settings-modal').classList.remove('show');
        document.getElementById('diff-modal').classList.remove('show');
        pendingSanitize = null;
        document.getElementById('diff-rules').innerHTML = '';
      }
    });

    loadDraft();
    toggleCustomModel();
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => switchLeftTab(btn.getAttribute('data-tab')));
    });
    let initialTab = 'basic';
    try {
      const t = localStorage.getItem('novel_left_tab_v1');
      if (t) initialTab = t;
    } catch (_) {}
    switchLeftTab(initialTab);
    loadModels();
    loadQuestions();
    renderChapters();
    renderQualitySummary();
    updateGenerateHint();
    updateTabMeta();
    refreshDashboard();
  </script>
</body>
</html>


